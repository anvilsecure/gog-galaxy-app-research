The GOG Galaxy Client allows the user to perform several operations which require elevated privileges. These operations are sent via an Inter-Process Communication (IPC) channel, signed with a cryptographic key, to the Galaxy Client Service which runs as `NT AUTHORITY\SYSTEM`. The service validates that the signature is correct, and that the IPC call comes from a trusted process. 

One of these operations, namely `FixDirectoryPrivileges`, receives a directory as a parameter and modifies the directory's Discretionary Access Control List (DACL) to allow Full Control to the principal `Everyone`. Since this parameter is not validated or sanitized, it is possible to send a privilege directory whose permissions will then be modified in this manner.

As an example, and for the Proof-Of-Concept, GOG's main directory `C:\Program Files (x86)\GOG Galaxy` was selected. Once this directory was world-writable, the service executable process was hijacked via a DLL binary planting. The DLL then opened a privileged shell running as `NT AUTHORITY\SYSTEM`.

In order to reproduce the issue, please refer to the following steps:

1. Obtain the files for the Proof-of-Concept from the `poc/` directory and save them in the same folder, with the names specified therein. 

2. Install Clang and MSVC++ on a windows computer and compile the files in the folder with the following commands:
```console
clang -m32 -masm=intel -shared -lwtsapi32 -lsecur32 -ladvapi32 -o profapi.dll .\profapi.cpp
clang -m32 -masm=intel -shared -o galaxy_dll.dll .\galaxy_dll.cpp
clang -m32 -o DLL_Injector.exe .\DLL_Injector.cpp 
```

From a PowerShell console, run the main exploit file `GOG_Galaxy_Local_Privilege_Escalation_PoC.ps1`. The exploit will ask that the user installs any game from the Galaxy Client. This should not be interpreted as "needing user interaction" (users will use the target application to install a game sooner or later). This is done for simplicity and proof-of-concept, since the injected DLL patches the function which sends the `FixDirectoryPrivileges` operation and modifies the path of the operation. This function is triggered whenever a game is installed, thus needing this manual step. A fully weaponized exploit will make use of the in-memory cryptographic key and send a forged packet. 

3. A CMD shell running as `NT AUTHORITY\SYSTEM` should pop up once the service restarts. If this does not automatically happen, restart the service with the following commands:

```
sc.exe stop GalaxyClientService
sc.exe start GalaxyClientService.
```

You should now be able to observe that the DACL of Galaxy's main directory now allows Full Access to the `Everyone` principal by right clicking on that folder and selecting `Properties > Security`.
